<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue Component in HTML</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="app">
        <stock-fetcher></stock-fetcher>
    </div>

    <script>
        const StockFetcher = {
            template: `
                <div>
                    <h2>Stock API Fetcher</h2>
                    <p>{{ statusMessage }}</p>
                    <ul>
                        <li v-for="url in apiUrls" :key="url">
                             <a :href="url">{{ url }}</a>
                            </li>
                    </ul>
                </div>
            `,
            data() {
                return {
                    jsonData: [],
                    apiUrls: [],
                    statusMessage: "載入中..."
                };
            },
            mounted() {
                this.loadExcelData();
            },
            methods: {
                async loadExcelData() {
                    let urlParams = new URLSearchParams(window.location.search);
                    let file = './Result/check.xlsx';

                    const fileMap = {
                        'T': './Result/check1.xlsx',
                        'S': './Result/check2.xlsx',
                        'M': './Result/checkmy.xlsx',
                        'O': './Result/check3.xlsx',
                        'H': './Result/check4.xlsx',
                        'A': './Result/checkall.xlsx',
                        'C': `./Result/checkall/${urlParams.get('date')}.xlsx`
                    };

                    if (urlParams.has('d') && fileMap[urlParams.get('d')]) {
                        file = fileMap[urlParams.get('d')];
                    }

                    try {
                        const response = await fetch(file);
                        const data = await response.arrayBuffer();
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        if (json.length > 0) {
                            const headers = json[0];
                            this.jsonData = json.slice(1).map(row => {
                                let rowData = {};
                                headers.forEach((header, i) => {
                                    rowData[header] = row[i];
                                });
                                return rowData;
                            });

                            this.generateStockApiUrls();
                        }
                    } catch (error) {
                        console.error('Error loading Excel file:', error);
                        this.statusMessage = "載入 Excel 失敗！";
                    }
                },

                generateStockApiUrls() {
                    const marketTypes = { 'tse': '上市', 'otc': '上櫃' };
                    let urls = [];

                    Object.entries(marketTypes).forEach(([type, market]) => {
                        debugger;
                        let targets = this.jsonData
                            .filter(stock => (type === 'tse' ? stock.Type2 === market : stock.Type !== '上市'))
                            .map(stock => stock.stock_number);

                        this.batchSize(targets, 50).forEach(batch => {
                            urls.push(this.buildStockApiUrl(batch, type));
                        });
                    });

                    this.apiUrls = urls;
                    this.statusMessage = `共找到 ${urls.length} 個 API URL`;
                },
                buildStockApiUrl(targets, type) {
                    let endpoint = 'https://mis.twse.com.tw/stock/api/getStockInfo.jsp';
                    let today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                    let channels = targets.map(target => `${type}_${target}.tw_${today}`).join('|');

                    return `${endpoint}?ex_ch=${channels}`;
                },

                batchSize(arr, size) {
                    return arr.reduce((acc, _, i) => {
                        if (i % size === 0) acc.push(arr.slice(i, i + size));
                        return acc;
                    }, []);
                }
            }
        };

        const app = Vue.createApp({});
        app.component('stock-fetcher', StockFetcher);
        app.mount('#app');
    </script>
</body>
</html>
